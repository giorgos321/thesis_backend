## Αυθεντικοποίηση και Ασφάλεια

Η ασφάλεια αποτελεί κρίσιμο παράγοντα για κάθε σύγχρονη διαδικτυακή εφαρμογή, ιδιαίτερα όταν αυτή διαχειρίζεται προσωπικά δεδομένα και ευαίσθητες πληροφορίες, όπως συμβαίνει με το σύστημα διαχείρισης εργαστηρίων. Στην ενότητα αυτή, αναλύονται οι μηχανισμοί αυθεντικοποίησης και ασφάλειας που εφαρμόστηκαν στο σύστημα, καθώς και οι βέλτιστες πρακτικές που ακολουθήθηκαν για την προστασία των δεδομένων και των λειτουργιών του συστήματος.

### Αυθεντικοποίηση Χρηστών

Η αυθεντικοποίηση των χρηστών είναι θεμελιώδης για την ασφάλεια του συστήματος, καθώς διασφαλίζει ότι μόνο εξουσιοδοτημένοι χρήστες έχουν πρόσβαση στους πόρους του συστήματος. Το σύστημα υλοποιεί ένα σύγχρονο μηχανισμό αυθεντικοποίησης βασισμένο σε JSON Web Tokens (JWT).

#### Εγγραφή Χρηστών (Sign up)

Η διαδικασία εγγραφής επιτρέπει τη δημιουργία νέων λογαριασμών χρηστών. Κατά την εγγραφή, οι κωδικοί πρόσβασης κρυπτογραφούνται πριν αποθηκευτούν στη βάση δεδομένων, χρησιμοποιώντας τη βιβλιοθήκη bcrypt:

```javascript
// Παράδειγμα από auth controller
const bcrypt = require('bcrypt');

// Δημιουργία νέου χρήστη
exports.signup = async (req, res) => {
  try {
    // Κρυπτογράφηση του κωδικού πρόσβασης
    const hashedPassword = bcrypt.hashSync(req.body.password, 8);
    
    // Δημιουργία χρήστη με κρυπτογραφημένο κωδικό
    const user = await models.user.create({
      username: req.body.username,
      email: req.body.email,
      password: hashedPassword,
      role: req.body.role
    });
    
    res.status(201).send({ message: "Ο χρήστης εγγράφηκε επιτυχώς!" });
  } catch (error) {
    res.status(500).send({ message: error.message });
  }
};
```

Η χρήση του bcrypt για την κρυπτογράφηση των κωδικών πρόσβασης παρέχει ισχυρή προστασία, καθώς:
- Δημιουργεί μοναδικά "salt" για κάθε κωδικό, αποτρέποντας επιθέσεις με προκαθορισμένους πίνακες (rainbow tables)
- Εφαρμόζει πολλαπλούς γύρους κρυπτογράφησης, καθιστώντας τις επιθέσεις brute force εξαιρετικά χρονοβόρες
- Παράγει διαφορετικά hashes ακόμα και για τον ίδιο κωδικό πρόσβασης, ενισχύοντας την ασφάλεια

#### Είσοδος Χρηστών (Sign in)

Κατά την είσοδο, το σύστημα επαληθεύει τα διαπιστευτήρια του χρήστη και, αν είναι έγκυρα, δημιουργεί ένα JWT που χρησιμοποιείται για την αυθεντικοποίηση των επόμενων αιτημάτων:

```javascript
// Παράδειγμα από auth controller
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');
const config = require('../config/auth.config');

// Είσοδος χρήστη
exports.signin = async (req, res) => {
  try {
    // Αναζήτηση χρήστη με βάση το username
    const user = await models.user.findOne({
      where: {
        username: req.body.username
      }
    });
    
    if (!user) {
      return res.status(404).send({ message: "Ο χρήστης δεν βρέθηκε." });
    }
    
    // Επαλήθευση κωδικού πρόσβασης
    const passwordIsValid = bcrypt.compareSync(
      req.body.password,
      user.password
    );
    
    if (!passwordIsValid) {
      return res.status(401).send({
        accessToken: null,
        message: "Μη έγκυρος κωδικός πρόσβασης!"
      });
    }
    
    // Δημιουργία token
    const token = jwt.sign({ id: user.id }, config.secret, {
      expiresIn: 86400 // 24 ώρες
    });
    
    // Επιστροφή token και πληροφοριών χρήστη
    res.status(200).send({
      id: user.id,
      username: user.username,
      email: user.email,
      role: user.role,
      accessToken: token
    });
  } catch (error) {
    res.status(500).send({ message: error.message });
  }
};
```

Το JWT περιέχει κωδικοποιημένες πληροφορίες για τον χρήστη, όπως το αναγνωριστικό του και πιθανώς το ρόλο του, και υπογράφεται ψηφιακά για να διασφαλιστεί η ακεραιότητά του. Το token έχει περιορισμένη διάρκεια ζωής (24 ώρες στο παράδειγμα), μειώνοντας έτσι τον κίνδυνο από κλοπή ή μη εξουσιοδοτημένη χρήση.

### Εξουσιοδότηση με JWT

Όλα τα προστατευμένα endpoints του API απαιτούν αυθεντικοποίηση μέσω JWT. Το middleware `authJwt` επαληθεύει την εγκυρότητα του token και εξάγει τις πληροφορίες του χρήστη:

```javascript
// express/middleware/authJwt.js
const jwt = require('jsonwebtoken');
const config = require('../config/auth.config');
const { models } = require('../../sequelize');

// Επαλήθευση token
const verifyToken = (req, res, next) => {
  // Ανάκτηση token από την κεφαλίδα του αιτήματος
  const token = req.headers['x-access-token'];
  
  if (!token) {
    return res.status(403).send({ message: 'Δεν παρέχεται token!' });
  }
  
  // Επαλήθευση και αποκωδικοποίηση του token
  jwt.verify(token, config.secret, (err, decoded) => {
    if (err) {
      return res.status(401).send({ message: 'Μη εξουσιοδοτημένο!' });
    }
    // Αποθήκευση του ID του χρήστη στο αίτημα για χρήση από άλλους χειριστές
    req.userId = decoded.id;
    next();
  });
};

module.exports = {
  verifyToken,
  // Άλλα middleware...
};
```

Αυτό το middleware εφαρμόζεται σε όλα τα προστατευμένα endpoints μέσω του συστήματος δρομολόγησης του Express, διασφαλίζοντας ότι μόνο αυθεντικοποιημένοι χρήστες μπορούν να αποκτήσουν πρόσβαση σε αυτά.

### Έλεγχος Πρόσβασης Βάσει Ρόλων (RBAC)

Το σύστημα υλοποιεί ένα μοντέλο ελέγχου πρόσβασης βάσει ρόλων, που επιτρέπει σε διαφορετικούς χρήστες να έχουν διαφορετικά δικαιώματα πρόσβασης, ανάλογα με το ρόλο τους. Οι κύριοι ρόλοι είναι:

1. **Διαχειριστής (Admin)**: Έχει πλήρη πρόσβαση σε όλες τις λειτουργίες του συστήματος
2. **Καθηγητής (Teacher)**: Μπορεί να διαχειρίζεται εργαστήρια, συνεδρίες και εγγραφές
3. **Φοιτητής (Student)**: Μπορεί να βλέπει διαθέσιμα εργαστήρια και να διαχειρίζεται τις εγγραφές του

Ο έλεγχος των ρόλων γίνεται μέσω πρόσθετων middleware:

```javascript
// express/middleware/authJwt.js

// Έλεγχος αν ο χρήστης είναι καθηγητής
const isTeacher = (req, res, next) => {
  models.user.findByPk(req.userId).then(user => {
    if (user.role === '2') {
      next();
      return;
    }
    res.status(403).send({ message: 'Απαιτείται ρόλος Καθηγητή!' });
  });
};

// Έλεγχος αν ο χρήστης είναι διαχειριστής
const isAdmin = (req, res, next) => {
  models.user.findByPk(req.userId).then(user => {
    if (user.role === '1') {
      next();
      return;
    }
    res.status(403).send({ message: 'Απαιτείται ρόλος Διαχειριστή!' });
  });
};

// Έλεγχος αν ο χρήστης είναι φοιτητής
const isStudent = (req, res, next) => {
  models.user.findByPk(req.userId).then(user => {
    if (user.role === '3') {
      next();
      return;
    }
    res.status(403).send({ message: 'Απαιτείται ρόλος Φοιτητή!' });
  });
};
```

Αυτά τα middleware εφαρμόζονται επιλεκτικά στα διάφορα endpoints, ανάλογα με το ρόλο που απαιτείται για την πρόσβαση σε κάθε πόρο. Για παράδειγμα, στο αρχείο `express/app.js`:

```javascript
function applyMiddleware(middleware, routeName) {
  switch (routeName) {
    case 'user':
      middleware.push(authJwt.isTeacher);
      break;
    case 'labs':
      middleware.push(authJwt.isTeacher);
      break;
    case 'teacher':
      middleware.push(authJwt.isTeacher);
      break;
    case 'labinstance':
      middleware.push(authJwt.isTeacher);
      break;
    case 'student':
      middleware.push(authJwt.isTeacher);
      break;
    case 'subscriptions':
      middleware.push(authJwt.isTeacher);
      break;
    default:
      break;
  }
  return middleware;
}
```

Αυτή η προσέγγιση διασφαλίζει ότι οι χρήστες έχουν πρόσβαση μόνο στους πόρους και τις λειτουργίες που αντιστοιχούν στο ρόλο τους, εφαρμόζοντας έτσι την αρχή των ελάχιστων προνομίων (principle of least privilege).

### Ασφάλεια Δεδομένων

#### Κρυπτογράφηση Κωδικών Πρόσβασης

Όπως αναφέρθηκε, οι κωδικοί πρόσβασης κρυπτογραφούνται με τη βιβλιοθήκη bcrypt πριν αποθηκευτούν στη βάση δεδομένων. Αυτό διασφαλίζει ότι ακόμα και αν υπάρξει διαρροή των δεδομένων, οι κωδικοί πρόσβασης δεν θα είναι άμεσα προσβάσιμοι.

#### Προστασία από Επιθέσεις

##### Cross-Site Request Forgery (CSRF)

Η χρήση των JWT μειώνει τον κίνδυνο επιθέσεων CSRF, καθώς το token πρέπει να συμπεριληφθεί ρητά σε κάθε αίτημα, και δεν βασίζεται σε cookies που αποστέλλονται αυτόματα.

##### Cross-Origin Resource Sharing (CORS)

Το σύστημα χρησιμοποιεί το middleware CORS για να ελέγχει ποιοι domains μπορούν να αλληλεπιδράσουν με το API:

```javascript
// express/app.js
const cors = require('cors');

app.use(cors());
```

Στην παραπάνω περίπτωση, το CORS επιτρέπει αιτήματα από οποιονδήποτε domain. Σε περιβάλλον παραγωγής, θα ήταν προτιμότερο να περιοριστεί η πρόσβαση μόνο σε συγκεκριμένους, έμπιστους domains:

```javascript
const corsOptions = {
  origin: 'https://example.com',
  optionsSuccessStatus: 200
};

app.use(cors(corsOptions));
```

##### SQL Injection

Το Sequelize ORM παρέχει προστασία έναντι επιθέσεων SQL injection, καθώς χρησιμοποιεί prepared statements και escape των παραμέτρων. Για παράδειγμα, στον κώδικα αναζήτησης χρήστη:

```javascript
const user = await models.user.findOne({
  where: {
    username: req.body.username
  }
});
```

Το Sequelize αυτόματα διαχειρίζεται το escaping του `req.body.username`, αποτρέποντας έτσι την εκτέλεση κακόβουλου SQL κώδικα.

#### Ασφαλείς Κεφαλίδες HTTP

Το σύστημα μπορεί να εφαρμόσει ασφαλείς κεφαλίδες HTTP για να προστατεύσει από διάφορες επιθέσεις:

```javascript
const helmet = require('helmet');
app.use(helmet());
```

Η βιβλιοθήκη Helmet παρέχει διάφορες κεφαλίδες ασφαλείας, όπως:
- `X-XSS-Protection`: Προστασία από cross-site scripting (XSS)
- `X-Content-Type-Options`: Αποτρέπει το MIME-type sniffing
- `X-Frame-Options`: Προστασία από clickjacking
- `Strict-Transport-Security`: Επιβάλλει ασφαλείς (HTTPS) συνδέσεις

## Καταγραφή και Παρακολούθηση

Η καταγραφή (logging) των ενεργειών και των προσπαθειών πρόσβασης είναι σημαντική για την ανίχνευση και αντιμετώπιση πιθανών παραβιάσεων ασφαλείας. Το σύστημα μπορεί να χρησιμοποιεί middleware για την καταγραφή των αιτημάτων:

```javascript
// Middleware καταγραφής
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.url} - ${req.ip}`);
  next();
});
```

Σε ένα πλήρες σύστημα παραγωγής, θα ήταν προτιμότερο να χρησιμοποιηθεί μια πιο προηγμένη λύση καταγραφής, όπως το Winston ή το Morgan, με αποθήκευση των logs σε βάση δεδομένων ή αρχεία.

### Βέλτιστες Πρακτικές Ασφάλειας

Το σύστημα ακολουθεί διάφορες βέλτιστες πρακτικές ασφάλειας:

1. **Κρυπτογράφηση ευαίσθητων δεδομένων**: Οι κωδικοί πρόσβασης κρυπτογραφούνται με bcrypt.

2. **Αυθεντικοποίηση με JWT**: Παρέχει ένα ασφαλές και κλιμακώσιμο μηχανισμό αυθεντικοποίησης.

3. **Έλεγχος πρόσβασης βάσει ρόλων**: Περιορίζει την πρόσβαση σε πόρους με βάση το ρόλο του χρήστη.

4. **Επικύρωση δεδομένων εισόδου**: Το Sequelize παρέχει μηχανισμούς επικύρωσης των δεδομένων.

5. **Προστασία από κοινές επιθέσεις**: Χρήση CORS, προστασία από SQL injection μέσω ORM.

6. **Περιορισμένη διάρκεια ζωής των tokens**: Μειώνει τον κίνδυνο από κλεμμένα tokens.

7. **Διαχείριση σφαλμάτων**: Αποφεύγει την αποκάλυψη ευαίσθητων πληροφοριών σε περίπτωση σφάλματος.

### Μελλοντικές Βελτιώσεις Ασφάλειας

Παρά τα μέτρα ασφαλείας που έχουν ήδη εφαρμοστεί, υπάρχουν πάντα περιθώρια βελτίωσης. Μερικές πιθανές μελλοντικές βελτιώσεις περιλαμβάνουν:

1. **Υλοποίηση αυθεντικοποίησης δύο παραγόντων (2FA)**: Προσθέτει ένα επιπλέον επίπεδο ασφάλειας στη διαδικασία αυθεντικοποίησης.

2. **Περιορισμός ρυθμού αιτημάτων (Rate limiting)**: Προστατεύει από επιθέσεις brute force και denial of service.

3. **Παρακολούθηση ασφάλειας σε πραγματικό χρόνο**: Εντοπισμός και αντιμετώπιση πιθανών παραβιάσεων σε πραγματικό χρόνο.

4. **Κρυπτογράφηση δεδομένων σε ηρεμία**: Όλα τα ευαίσθητα δεδομένα θα μπορούσαν να κρυπτογραφηθούν στη βάση δεδομένων.

5. **Εφαρμογή OAuth 2.0 ή OpenID Connect**: Για πιο εύρωστη αυθεντικοποίηση και εξουσιοδότηση.

### Συμπέρασμα

Η ασφάλεια είναι ένα κρίσιμο στοιχείο του συστήματος διαχείρισης εργαστηρίων, εξασφαλίζοντας την προστασία των προσωπικών δεδομένων και την ακεραιότητα του συστήματος. Μέσω της εφαρμογής σύγχρονων τεχνικών αυθεντικοποίησης και εξουσιοδότησης, όπως τα JWT και ο έλεγχος πρόσβασης βάσει ρόλων, καθώς και της υιοθέτησης βέλτιστων πρακτικών ασφάλειας, το σύστημα παρέχει ένα υψηλό επίπεδο προστασίας έναντι των κοινών απειλών και επιθέσεων.

Ωστόσο, η ασφάλεια είναι μια συνεχής διαδικασία που απαιτεί διαρκή παρακολούθηση, αξιολόγηση και βελτίωση. Καθώς εμφανίζονται νέες απειλές και τεχνικές, το σύστημα θα πρέπει να προσαρμόζεται και να ενισχύει τους μηχανισμούς ασφαλείας του για να διασφαλίζει την προστασία των δεδομένων και των χρηστών του. 